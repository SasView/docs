
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>sasmodels.jitter &#8212; SasView 5.0.3 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SasView 5.0.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../sasmodels.html" accesskey="U">sasmodels</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sasmodels.jitter</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Jitter Explorer</span>
<span class="sd">===============</span>

<span class="sd">Application to explore orientation angle and angular dispersity.</span>

<span class="sd">From the command line::</span>

<span class="sd">    # Show docs</span>
<span class="sd">    python -m sasmodels.jitter --help</span>

<span class="sd">    # Guyou projection jitter, uniform over 20 degree theta and 10 in phi</span>
<span class="sd">    python -m sasmodels.jitter --projection=guyou --dist=uniform --jitter=20,10,0</span>

<span class="sd">From a jupyter cell::</span>

<span class="sd">    import ipyvolume as ipv</span>
<span class="sd">    from sasmodels import jitter</span>
<span class="sd">    import importlib; importlib.reload(jitter)</span>
<span class="sd">    jitter.set_plotter(&quot;ipv&quot;)</span>

<span class="sd">    size = (10, 40, 100)</span>
<span class="sd">    view = (20, 0, 0)</span>

<span class="sd">    #size = (15, 15, 100)</span>
<span class="sd">    #view = (60, 60, 0)</span>

<span class="sd">    dview = (0, 0, 0)</span>
<span class="sd">    #dview = (5, 5, 0)</span>
<span class="sd">    #dview = (15, 180, 0)</span>
<span class="sd">    #dview = (180, 15, 0)</span>

<span class="sd">    projection = &#39;equirectangular&#39;</span>
<span class="sd">    #projection = &#39;azimuthal_equidistance&#39;</span>
<span class="sd">    #projection = &#39;guyou&#39;</span>
<span class="sd">    #projection = &#39;sinusoidal&#39;</span>
<span class="sd">    #projection = &#39;azimuthal_equal_area&#39;</span>

<span class="sd">    dist = &#39;uniform&#39;</span>
<span class="sd">    #dist = &#39;gaussian&#39;</span>

<span class="sd">    jitter.run(size=size, view=view, jitter=dview, dist=dist, projection=projection)</span>
<span class="sd">    #filename = projection+(&#39;_theta&#39; if dview[0] == 180 else &#39;_phi&#39; if dview[1] == 180 else &#39;&#39;)</span>
<span class="sd">    #ipv.savefig(filename+&#39;.png&#39;)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">argparse</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">pi</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">degrees</span><span class="p">,</span> <span class="n">radians</span><span class="p">,</span> <span class="n">arccos</span><span class="p">,</span> <span class="n">arctan2</span>

<span class="c1"># Too many complaints about variable names from pylint:</span>
<span class="c1">#    a, b, c, u, v, x, y, z, dx, dy, dz, px, py, pz, R, Rx, Ry, Rz, ...</span>
<span class="c1"># pylint: disable=invalid-name</span>

<div class="viewcode-block" id="draw_beam"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_beam">[docs]</a><span class="k">def</span> <span class="nf">draw_beam</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw the beam going from source at (0, 0, 1) to detector at (0, 0, -1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#axes.plot([0,0],[0,0],[1,-1])</span>
    <span class="c1">#axes.scatter([0]*100,[0]*100,np.linspace(1, -1, 100), alpha=alpha)</span>

    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="mf">0.02</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mf">1.3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>

    <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="n">view</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">z</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">Rz</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">Ry</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">points</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span></div>

    <span class="c1"># TODO: draw endcaps on beam</span>
    <span class="c1">## Drawing tiny balls on the end will work</span>
    <span class="c1">#draw_sphere(axes, radius=0.02, center=(0, 0, 1.3), color=&#39;yellow&#39;, alpha=alpha)</span>
    <span class="c1">#draw_sphere(axes, radius=0.02, center=(0, 0, -1.3), color=&#39;yellow&#39;, alpha=alpha)</span>
    <span class="c1">## The following does not work</span>
    <span class="c1">#triangles = [(0, i+1, i+2) for i in range(steps-2)]</span>
    <span class="c1">#x_cap, y_cap = x[:, 0], y[:, 0]</span>
    <span class="c1">#for z_cap in z[:, 0], z[:, -1]:</span>
    <span class="c1">#    axes.plot_trisurf(x_cap, y_cap, z_cap, triangles,</span>
    <span class="c1">#                      color=&#39;yellow&#39;, alpha=alpha)</span>


<div class="viewcode-block" id="draw_ellipsoid"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_ellipsoid">[docs]</a><span class="k">def</span> <span class="nf">draw_ellipsoid</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw an ellipsoid.&quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">size</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

    <span class="n">axes</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="n">draw_labels</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;c+&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">c</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;c-&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;a+&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;a-&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;b+&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">b</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">]),</span>
    <span class="p">])</span></div>

<div class="viewcode-block" id="draw_sc"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_sc">[docs]</a><span class="k">def</span> <span class="nf">draw_sc</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw points for simple cubic paracrystal&quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=unused-argument</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">_build_sc</span><span class="p">()</span>
    <span class="n">_draw_crystal</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">)</span></div>

<div class="viewcode-block" id="draw_fcc"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_fcc">[docs]</a><span class="k">def</span> <span class="nf">draw_fcc</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw points for face-centered cubic paracrystal&quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=unused-argument</span>
    <span class="c1"># Build the simple cubic crystal</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">_build_sc</span><span class="p">()</span>
    <span class="c1"># Define the centers for each face</span>
    <span class="c1"># x planes at -1, 0, 1 have four centers per plane, at +/- 0.5 in y and z</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
        <span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">12</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># y and z planes can be generated by substituting x for y and z respectively</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">+</span><span class="n">z</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">z</span><span class="o">+</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="o">+</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">))</span>
    <span class="n">_draw_crystal</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">)</span></div>

<div class="viewcode-block" id="draw_bcc"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_bcc">[docs]</a><span class="k">def</span> <span class="nf">draw_bcc</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw points for body-centered cubic paracrystal&quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=unused-argument</span>
    <span class="c1"># Build the simple cubic crystal</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">_build_sc</span><span class="p">()</span>
    <span class="c1"># Define the centers for each octant</span>
    <span class="c1"># x plane at +/- 0.5 have four centers per plane at +/- 0.5 in y and z</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
        <span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
    <span class="n">_draw_crystal</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_draw_crystal</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">atoms</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">*</span><span class="n">size</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_build_sc</span><span class="p">():</span>
    <span class="c1"># three planes of 9 dots for x at -1, 0 and 1</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">9</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">9</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">9</span><span class="p">,</span>
        <span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">9</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
    <span class="c1">#print(list(enumerate(atoms)))</span>
    <span class="c1"># Pull the dot at (0, 0, 1) to the front of the list</span>
    <span class="c1"># It will be highlighted in the view</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">14</span>
    <span class="n">highlight</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">atoms</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">highlight</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">atoms</span>

<div class="viewcode-block" id="draw_box"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_box">[docs]</a><span class="k">def</span> <span class="nf">draw_box</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw a wireframe box at a particular view.&quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">size</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_draw</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span> <span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span> <span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">_draw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">_draw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">_draw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">_draw</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">_draw</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">_draw</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span></div>

<div class="viewcode-block" id="draw_parallelepiped"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_parallelepiped">[docs]</a><span class="k">def</span> <span class="nf">draw_parallelepiped</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw a parallelepiped surface, with view and jitter.&quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=unused-argument</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">size</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">tri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="c1"># counter clockwise triangles</span>
        <span class="c1"># z: up/down, x: right/left, y: front/back</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="c1"># top face</span>
        <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="c1"># bottom face</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="c1"># right face</span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="c1"># left face</span>
        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="c1"># front face</span>
        <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="c1"># back face</span>
    <span class="p">])</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">plot_trisurf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">triangles</span><span class="o">=</span><span class="n">tri</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                      <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Colour the c+ face of the box.</span>
    <span class="c1"># Since I can&#39;t control face color, instead draw a thin box situated just</span>
    <span class="c1"># in front of the &quot;c+&quot; face.  Use the c face so that rotations about psi</span>
    <span class="c1"># rotate that face.</span>
    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># pylint: disable=using-constant-test</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>  <span class="c1"># pink</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">c</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">+</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">plot_trisurf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">triangles</span><span class="o">=</span><span class="n">tri</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="n">draw_labels</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;c+&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">c</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;c-&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;a+&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;a-&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;b+&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">b</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">(</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">0</span><span class="p">]),</span>
    <span class="p">])</span></div>

<div class="viewcode-block" id="draw_sphere"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_sphere">[docs]</a><span class="k">def</span> <span class="nf">draw_sphere</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw a sphere&quot;&quot;&quot;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">u</span><span class="p">)),</span> <span class="n">cos</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span></div>
    <span class="c1">#axes.plot_wireframe(x, y, z)</span>

<div class="viewcode-block" id="draw_axes"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_axes">[docs]</a><span class="k">def</span> <span class="nf">draw_axes</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Draw wireframe axes lines, with given origin and length&quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">origin</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="n">length</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="n">dx</span><span class="p">],</span> <span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">dy</span><span class="p">],</span> <span class="p">[</span><span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="o">+</span><span class="n">dz</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="draw_person_on_sphere"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_person_on_sphere">[docs]</a><span class="k">def</span> <span class="nf">draw_person_on_sphere</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw a person on the surface of a sphere.</span>

<span class="sd">    *view* indicates (latitude, longitude, orientation)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">limb_offset</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="mf">0.05</span>
    <span class="n">head_radius</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="mf">0.10</span>
    <span class="n">head_height</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="n">head_radius</span>
    <span class="n">neck_length</span> <span class="o">=</span> <span class="n">head_radius</span> <span class="o">*</span> <span class="mf">0.50</span>
    <span class="n">shoulder_height</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">head_radius</span> <span class="o">-</span> <span class="n">neck_length</span>
    <span class="n">torso_length</span> <span class="o">=</span> <span class="n">shoulder_height</span> <span class="o">*</span> <span class="mf">0.55</span>
    <span class="n">torso_radius</span> <span class="o">=</span> <span class="n">torso_length</span> <span class="o">*</span> <span class="mf">0.30</span>
    <span class="n">leg_length</span> <span class="o">=</span> <span class="n">shoulder_height</span> <span class="o">-</span> <span class="n">torso_length</span>
    <span class="n">arm_length</span> <span class="o">=</span> <span class="n">torso_length</span> <span class="o">*</span> <span class="mf">0.90</span>

    <span class="k">def</span> <span class="nf">_draw_part</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">zp</span> <span class="o">=</span> <span class="n">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">+</span> <span class="n">radius</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">zp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="c1"># circle for head</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">head_radius</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">head_radius</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">+</span> <span class="n">head_height</span>
    <span class="n">_draw_part</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

    <span class="c1"># rectangle for body</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">torso_radius</span><span class="p">,</span> <span class="n">torso_radius</span><span class="p">,</span> <span class="n">torso_radius</span><span class="p">,</span> <span class="o">-</span><span class="n">torso_radius</span><span class="p">,</span> <span class="o">-</span><span class="n">torso_radius</span><span class="p">])</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torso_length</span><span class="p">,</span> <span class="n">torso_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">leg_length</span>
    <span class="n">_draw_part</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

    <span class="c1"># arms</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">torso_radius</span> <span class="o">-</span> <span class="n">limb_offset</span><span class="p">,</span> <span class="o">-</span><span class="n">torso_radius</span> <span class="o">-</span> <span class="n">limb_offset</span><span class="p">,</span> <span class="o">-</span><span class="n">torso_radius</span><span class="p">])</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shoulder_height</span> <span class="o">-</span> <span class="n">arm_length</span><span class="p">,</span> <span class="n">shoulder_height</span><span class="p">,</span> <span class="n">shoulder_height</span><span class="p">])</span>
    <span class="n">_draw_part</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">_draw_part</span><span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-unary-operand-type</span>

    <span class="c1"># legs</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">torso_radius</span> <span class="o">+</span> <span class="n">limb_offset</span><span class="p">,</span> <span class="o">-</span><span class="n">torso_radius</span> <span class="o">+</span> <span class="n">limb_offset</span><span class="p">])</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">leg_length</span><span class="p">])</span>
    <span class="n">_draw_part</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">_draw_part</span><span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-unary-operand-type</span>

    <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">radius</span><span class="o">-</span><span class="n">height</span><span class="p">,</span> <span class="n">radius</span><span class="o">+</span><span class="n">height</span><span class="p">]</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">limits</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limits</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">limits</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span></div>

<div class="viewcode-block" id="draw_jitter"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_jitter">[docs]</a><span class="k">def</span> <span class="nf">draw_jitter</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="n">draw_shape</span><span class="o">=</span><span class="n">draw_parallelepiped</span><span class="p">,</span>
                <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;equirectangular&#39;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">views</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represent jitter as a set of shapes at different orientations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">project</span><span class="p">,</span> <span class="n">project_weight</span> <span class="o">=</span> <span class="n">get_projection</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

    <span class="c1"># set max diagonal to 0.95</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.95</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">size</span><span class="p">))</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">scale</span><span class="o">*</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">size</span><span class="p">)</span>

    <span class="n">dtheta</span><span class="p">,</span> <span class="n">dphi</span><span class="p">,</span> <span class="n">dpsi</span> <span class="o">=</span> <span class="n">jitter</span>
    <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gaussian&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">:</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}[</span><span class="n">dist</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_steps</span><span class="p">(</span><span class="n">delta</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">views</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">base</span><span class="o">*</span><span class="n">delta</span><span class="o">/</span><span class="mi">5</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">views</span>
        <span class="k">return</span> <span class="n">base</span><span class="o">*</span><span class="n">delta</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">_steps</span><span class="p">(</span><span class="n">dtheta</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">phi</span> <span class="ow">in</span> <span class="n">_steps</span><span class="p">(</span><span class="n">dphi</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">psi</span> <span class="ow">in</span> <span class="n">_steps</span><span class="p">(</span><span class="n">dpsi</span><span class="p">):</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">project_weight</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dview</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span><span class="p">)</span>
                    <span class="n">draw_shape</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">dview</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">size</span>
        <span class="n">lim</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="s1">&#39;set_&#39;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s1">&#39;lim&#39;</span><span class="p">)([</span><span class="o">-</span><span class="n">lim</span><span class="p">,</span> <span class="n">lim</span><span class="p">])</span></div>
        <span class="c1">#getattr(axes, v+&#39;axis&#39;).label.set_text(v)</span>

<span class="n">PROJECTIONS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># in order of PROJECTION number; do not change without updating the</span>
    <span class="c1"># constants in kernel_iq.c</span>
    <span class="s1">&#39;equirectangular&#39;</span><span class="p">,</span> <span class="s1">&#39;sinusoidal&#39;</span><span class="p">,</span> <span class="s1">&#39;guyou&#39;</span><span class="p">,</span> <span class="s1">&#39;azimuthal_equidistance&#39;</span><span class="p">,</span>
    <span class="s1">&#39;azimuthal_equal_area&#39;</span><span class="p">,</span>
<span class="p">]</span>
<div class="viewcode-block" id="get_projection"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.get_projection">[docs]</a><span class="k">def</span> <span class="nf">get_projection</span><span class="p">(</span><span class="n">projection</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    jitter projections</span>
<span class="sd">    &lt;https://en.wikipedia.org/wiki/List_of_map_projections&gt;</span>

<span class="sd">    equirectangular (standard latitude-longitude mesh)</span>
<span class="sd">        &lt;https://en.wikipedia.org/wiki/Equirectangular_projection&gt;</span>
<span class="sd">        Allows free movement in phi (around the equator), but theta is</span>
<span class="sd">        limited to +/- 90, and points are cos-weighted. Jitter in phi is</span>
<span class="sd">        uniform in weight along a line of latitude.  With small theta and</span>
<span class="sd">        phi ranging over +/- 180 this forms a wobbling disk.  With small</span>
<span class="sd">        phi and theta ranging over +/- 90 this forms a wedge like a slice</span>
<span class="sd">        of an orange.</span>
<span class="sd">    azimuthal_equidistance (Postel)</span>
<span class="sd">        &lt;https://en.wikipedia.org/wiki/Azimuthal_equidistant_projection&gt;</span>
<span class="sd">        Preserves distance from center, and so is an excellent map for</span>
<span class="sd">        representing a bivariate gaussian on the surface.  Theta and phi</span>
<span class="sd">        operate identically, cutting wegdes from the antipode of the viewing</span>
<span class="sd">        angle.  This unfortunately does not allow free movement in either</span>
<span class="sd">        theta or phi since the orthogonal wobble decreases to 0 as the body</span>
<span class="sd">        rotates through 180 degrees.</span>
<span class="sd">    sinusoidal (Sanson-Flamsteed, Mercator equal-area)</span>
<span class="sd">        &lt;https://en.wikipedia.org/wiki/Sinusoidal_projection&gt;</span>
<span class="sd">        Preserves arc length with latitude, giving bad behaviour at</span>
<span class="sd">        theta near +/- 90.  Theta and phi operate somewhat differently,</span>
<span class="sd">        so a system with a-b-c dtheta-dphi-dpsi will not give the same</span>
<span class="sd">        value as one with b-a-c dphi-dtheta-dpsi, as would be the case</span>
<span class="sd">        for azimuthal equidistance.  Free movement using theta or phi</span>
<span class="sd">        uniform over +/- 180 will work, but not as well as equirectangular</span>
<span class="sd">        phi, with theta being slightly worse.  Computationally it is much</span>
<span class="sd">        cheaper for wide theta-phi meshes since it excludes points which</span>
<span class="sd">        lie outside the sinusoid near theta +/- 90 rather than packing</span>
<span class="sd">        them close together as in equirectangle.  Note that the poles</span>
<span class="sd">        will be slightly overweighted for theta &gt; 90 with the circle</span>
<span class="sd">        from theta at 90+dt winding backwards around the pole, overlapping</span>
<span class="sd">        the circle from theta at 90-dt.</span>
<span class="sd">    Guyou (hemisphere-in-a-square) **not weighted**</span>
<span class="sd">        &lt;https://en.wikipedia.org/wiki/Guyou_hemisphere-in-a-square_projection&gt;</span>
<span class="sd">        With tiling, allows rotation in phi or theta through +/- 180, with</span>
<span class="sd">        uniform spacing.  Both theta and phi allow free rotation, with wobble</span>
<span class="sd">        in the orthogonal direction reasonably well behaved (though not as</span>
<span class="sd">        good as equirectangular phi). The forward/reverse transformations</span>
<span class="sd">        relies on elliptic integrals that are somewhat expensive, so the</span>
<span class="sd">        behaviour has to be very good to justify the cost and complexity.</span>
<span class="sd">        The weighting function for each point has not yet been computed.</span>
<span class="sd">        Note: run the module *guyou.py* directly and it will show the forward</span>
<span class="sd">        and reverse mappings.</span>
<span class="sd">    azimuthal_equal_area  **incomplete**</span>
<span class="sd">        &lt;https://en.wikipedia.org/wiki/Lambert_azimuthal_equal-area_projection&gt;</span>
<span class="sd">        Preserves the relative density of the surface patches.  Not that</span>
<span class="sd">        useful and not completely implemented</span>
<span class="sd">    Gauss-Kreuger **not implemented**</span>
<span class="sd">        &lt;https://en.wikipedia.org/wiki/Transverse_Mercator_projection#Ellipsoidal_transverse_Mercator&gt;</span>
<span class="sd">        Should allow free movement in theta, but phi is distorted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=unused-argument</span>
    <span class="c1"># TODO: try Kent distribution instead of a gaussian warped by projection</span>

    <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;equirectangular&#39;</span><span class="p">:</span>  <span class="c1">#define PROJECTION 1</span>
        <span class="k">def</span> <span class="nf">_project</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">psi</span><span class="p">):</span>
            <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span> <span class="o">=</span> <span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span>
            <span class="k">return</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="s1">&#39;xyz&#39;</span>
            <span class="c1">#return Rx(phi_j)*Ry(theta_i)</span>
        <span class="k">def</span> <span class="nf">_weight</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">w_j</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">w_i</span><span class="o">*</span><span class="n">w_j</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">theta_i</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;sinusoidal&#39;</span><span class="p">:</span>  <span class="c1">#define PROJECTION 2</span>
        <span class="k">def</span> <span class="nf">_project</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">psi</span><span class="p">):</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="n">theta_i</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">latitude</span><span class="p">))</span>
            <span class="n">longitude</span> <span class="o">=</span> <span class="n">phi_j</span><span class="o">/</span><span class="n">scale</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">phi_j</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span><span class="o">*</span><span class="mi">180</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="c1">#print(&quot;(%+7.2f, %+7.2f) =&gt; (%+7.2f, %+7.2f)&quot;%(theta_i, phi_j, latitude, longitude))</span>
            <span class="k">return</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="s1">&#39;xyz&#39;</span>
            <span class="c1">#return Rx(longitude)*Ry(latitude)</span>
        <span class="k">def</span> <span class="nf">_project</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">w_j</span><span class="p">):</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="n">theta_i</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">latitude</span><span class="p">))</span>
            <span class="n">active</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">phi_j</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span><span class="o">*</span><span class="mi">180</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">active</span><span class="o">*</span><span class="n">w_i</span><span class="o">*</span><span class="n">w_j</span>
    <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;guyou&#39;</span><span class="p">:</span>  <span class="c1">#define PROJECTION 3  (eventually?)</span>
        <span class="k">def</span> <span class="nf">_project</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">psi</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">.guyou</span> <span class="k">import</span> <span class="n">guyou_invert</span>
            <span class="c1">#latitude, longitude = guyou_invert([theta_i], [phi_j])</span>
            <span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span> <span class="o">=</span> <span class="n">guyou_invert</span><span class="p">([</span><span class="n">phi_j</span><span class="p">],</span> <span class="p">[</span><span class="n">theta_i</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="s1">&#39;xyz&#39;</span>
            <span class="c1">#return Rx(longitude[0])*Ry(latitude[0])</span>
        <span class="k">def</span> <span class="nf">_weight</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">w_j</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">w_i</span><span class="o">*</span><span class="n">w_j</span>
    <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;azimuthal_equidistance&#39;</span><span class="p">:</span>
        <span class="c1"># Note that calculates angles for Rz Ry rather than Rx Ry</span>
        <span class="k">def</span> <span class="nf">_project</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">psi</span><span class="p">):</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">theta_i</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">phi_j</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">longitude</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">arctan2</span><span class="p">(</span><span class="n">phi_j</span><span class="p">,</span> <span class="n">theta_i</span><span class="p">))</span>
            <span class="c1">#print(&quot;(%+7.2f, %+7.2f) =&gt; (%+7.2f, %+7.2f)&quot;%(theta_i, phi_j, latitude, longitude))</span>
            <span class="k">return</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">psi</span><span class="o">-</span><span class="n">longitude</span><span class="p">,</span> <span class="s1">&#39;zyz&#39;</span>
            <span class="c1">#R = Rz(longitude)*Ry(latitude)*Rz(psi)</span>
            <span class="c1">#return R_to_xyz(R)</span>
            <span class="c1">#return Rz(longitude)*Ry(latitude)</span>
        <span class="k">def</span> <span class="nf">_weight</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">w_j</span><span class="p">):</span>
            <span class="c1"># Weighting for each point comes from the integral:</span>
            <span class="c1">#     \int\int I(q, lat, log) sin(lat) dlat dlog</span>
            <span class="c1"># We are doing a conformal mapping from disk to sphere, so we need</span>
            <span class="c1"># a change of variables g(theta, phi) -&gt; (lat, long):</span>
            <span class="c1">#     lat, long = sqrt(theta^2 + phi^2), arctan(phi/theta)</span>
            <span class="c1"># giving:</span>
            <span class="c1">#     dtheta dphi = det(J) dlat dlong</span>
            <span class="c1"># where J is the jacobian from the partials of g. Using</span>
            <span class="c1">#     R = sqrt(theta^2 + phi^2),</span>
            <span class="c1"># then</span>
            <span class="c1">#     J = [[x/R, Y/R], -y/R^2, x/R^2]]</span>
            <span class="c1"># and</span>
            <span class="c1">#     det(J) = 1/R</span>
            <span class="c1"># with the final integral being:</span>
            <span class="c1">#    \int\int I(q, theta, phi) sin(R)/R dtheta dphi</span>
            <span class="c1">#</span>
            <span class="c1"># This does approximately the right thing, decreasing the weight</span>
            <span class="c1"># of each point as you go farther out on the disk, but it hasn&#39;t</span>
            <span class="c1"># yet been checked against the 1D integral results. Prior</span>
            <span class="c1"># to declaring this &quot;good enough&quot; and checking that integrals</span>
            <span class="c1"># work in practice, we will examine alternative mappings.</span>
            <span class="c1">#</span>
            <span class="c1"># The issue is that the mapping does not support the case of free</span>
            <span class="c1"># rotation about a single axis correctly, with a small deviation</span>
            <span class="c1"># in the orthogonal axis independent of the first axis.  Like the</span>
            <span class="c1"># usual polar coordiates integration, the integrated sections</span>
            <span class="c1"># form wedges, though at least in this case the wedge cuts through</span>
            <span class="c1"># the entire sphere, and treats theta and phi identically.</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">theta_i</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">phi_j</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">latitude</span><span class="p">))</span><span class="o">/</span><span class="n">latitude</span> <span class="k">if</span> <span class="n">latitude</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">weight</span><span class="o">*</span><span class="n">w_i</span><span class="o">*</span><span class="n">w_j</span> <span class="k">if</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mi">180</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;azimuthal_equal_area&#39;</span><span class="p">:</span>
        <span class="c1"># Note that calculates angles for Rz Ry rather than Rx Ry</span>
        <span class="k">def</span> <span class="nf">_project</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">psi</span><span class="p">):</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">theta_i</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">phi_j</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="mi">180</span><span class="o">-</span><span class="n">degrees</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">arccos</span><span class="p">(</span><span class="n">radius</span><span class="p">))</span>
            <span class="n">longitude</span> <span class="o">=</span> <span class="n">degrees</span><span class="p">(</span><span class="n">arctan2</span><span class="p">(</span><span class="n">phi_j</span><span class="p">,</span> <span class="n">theta_i</span><span class="p">))</span>
            <span class="c1">#print(&quot;(%+7.2f, %+7.2f) =&gt; (%+7.2f, %+7.2f)&quot;%(theta_i, phi_j, latitude, longitude))</span>
            <span class="k">return</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="s1">&#39;zyz&#39;</span>
            <span class="c1">#R = Rz(longitude)*Ry(latitude)*Rz(psi)</span>
            <span class="c1">#return R_to_xyz(R)</span>
            <span class="c1">#return Rz(longitude)*Ry(latitude)</span>
        <span class="k">def</span> <span class="nf">_weight</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">w_j</span><span class="p">):</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">theta_i</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">phi_j</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">latitude</span><span class="p">))</span><span class="o">/</span><span class="n">latitude</span> <span class="k">if</span> <span class="n">latitude</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">weight</span><span class="o">*</span><span class="n">w_i</span><span class="o">*</span><span class="n">w_j</span> <span class="k">if</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mi">180</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown projection </span><span class="si">%r</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">projection</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_project</span><span class="p">,</span> <span class="n">_weight</span></div>

<div class="viewcode-block" id="R_to_xyz"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.R_to_xyz">[docs]</a><span class="k">def</span> <span class="nf">R_to_xyz</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return phi, theta, psi Tait-Bryan angles corresponding to the given rotation matrix.</span>

<span class="sd">    Extracting Euler Angles from a Rotation Matrix</span>
<span class="sd">    Mike Day, Insomniac Games</span>
<span class="sd">    https://d3cw3dd2w32x2b.cloudfront.net/wp-content/uploads/2012/07/euler-angles1.pdf</span>
<span class="sd">    Based on: Shoemake’s &quot;Euler Angle Conversion&quot;, Graphics Gems IV, pp.  222-229</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">arctan2</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">degrees</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">degrees</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">degrees</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span></div>

<div class="viewcode-block" id="draw_mesh"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_mesh">[docs]</a><span class="k">def</span> <span class="nf">draw_mesh</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span>
              <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;equirectangular&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw the dispersion mesh showing the theta-phi orientations at which</span>
<span class="sd">    the model will be evaluated.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_project</span><span class="p">,</span> <span class="n">_weight</span> <span class="o">=</span> <span class="n">get_projection</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_rotate</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">dview</span> <span class="o">=</span> <span class="n">_project</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dview</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;zyz&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Rz</span><span class="p">(</span><span class="n">dview</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">Ry</span><span class="p">(</span><span class="n">dview</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">z</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># dview[3] == &#39;xyz&#39;:</span>
            <span class="k">return</span> <span class="n">Rx</span><span class="p">(</span><span class="n">dview</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">Ry</span><span class="p">(</span><span class="n">dview</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">z</span>


    <span class="n">dist_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dist_x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dist</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
        <span class="n">dist_x</span> <span class="o">*=</span> <span class="mi">3</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dist_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dist</span> <span class="o">==</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">:</span>
        <span class="c1"># Note: uses sasmodels ridiculous definition of rectangle width</span>
        <span class="n">dist_x</span> <span class="o">*=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dist</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;expected dist to be gaussian, rectangle or uniform&quot;</span><span class="p">)</span>

    <span class="c1"># mesh in theta, phi formed by rotating z</span>
    <span class="n">dtheta</span><span class="p">,</span> <span class="n">dphi</span><span class="p">,</span> <span class="n">dpsi</span> <span class="o">=</span> <span class="n">jitter</span>  <span class="c1"># pylint: disable=unused-variable</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">radius</span><span class="p">]])</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">_rotate</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">theta_i</span> <span class="ow">in</span> <span class="n">dtheta</span><span class="o">*</span><span class="n">dist_x</span>
                        <span class="k">for</span> <span class="n">phi_j</span> <span class="ow">in</span> <span class="n">dphi</span><span class="o">*</span><span class="n">dist_x</span><span class="p">])</span>
    <span class="n">dist_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_weight</span><span class="p">(</span><span class="n">theta_i</span><span class="p">,</span> <span class="n">phi_j</span><span class="p">,</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">w_j</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">theta_i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtheta</span><span class="o">*</span><span class="n">dist_x</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">w_j</span><span class="p">,</span> <span class="n">phi_j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dphi</span><span class="o">*</span><span class="n">dist_x</span><span class="p">)])</span>
    <span class="c1">#print(max(dist_w), min(dist_w), min(dist_w[dist_w &gt; 0]))</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[:,</span> <span class="n">dist_w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">dist_w</span> <span class="o">=</span> <span class="n">dist_w</span><span class="p">[</span><span class="n">dist_w</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">dist_w</span> <span class="o">/=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dist_w</span><span class="p">)</span>

    <span class="c1"># rotate relative to beam</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">orient_relative_to_beam</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
    <span class="c1">#plt.figure(2); plt.clf(); plt.hist(z, bins=np.linspace(-1, 1, 51))</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">dist_w</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span></div>

<div class="viewcode-block" id="draw_labels"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_labels">[docs]</a><span class="k">def</span> <span class="nf">draw_labels</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw text at a particular location.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">labels</span><span class="p">,</span> <span class="n">locations</span><span class="p">,</span> <span class="n">orientations</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">text</span><span class="p">)</span>
    <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">locations</span><span class="p">)</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">orientations</span><span class="p">)</span>

    <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span> <span class="o">=</span> <span class="n">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">)</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span> <span class="o">=</span> <span class="n">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span>

    <span class="c1"># TODO: zdir for labels is broken, and labels aren&#39;t appearing.</span>
    <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">zdir</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">),</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">)):</span>
        <span class="n">zdir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">zdir</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="p">,</span> <span class="n">zdir</span><span class="o">=</span><span class="n">zdir</span><span class="p">)</span></div>

<span class="c1"># Definition of rotation matrices comes from wikipedia:</span>
<span class="c1">#    https://en.wikipedia.org/wiki/Rotation_matrix#Basic_rotations</span>
<div class="viewcode-block" id="Rx"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.Rx">[docs]</a><span class="k">def</span> <span class="nf">Rx</span><span class="p">(</span><span class="n">angle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a matrix to rotate points about *x* by *angle* degrees.&quot;&quot;&quot;</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)],</span>
           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="o">+</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)]]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ry"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.Ry">[docs]</a><span class="k">def</span> <span class="nf">Ry</span><span class="p">(</span><span class="n">angle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a matrix to rotate points about *y* by *angle* degrees.&quot;&quot;&quot;</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="p">[[</span><span class="o">+</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)],</span>
           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
           <span class="p">[</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)]]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rz"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.Rz">[docs]</a><span class="k">def</span> <span class="nf">Rz</span><span class="p">(</span><span class="n">angle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a matrix to rotate points about *z* by *angle* degrees.&quot;&quot;&quot;</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="p">[[</span><span class="o">+</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
           <span class="p">[</span><span class="o">+</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="o">+</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span></div>

<div class="viewcode-block" id="transform_xyz"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.transform_xyz">[docs]</a><span class="k">def</span> <span class="nf">transform_xyz</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send a set of (x,y,z) points through the jitter and view transforms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)]</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">z</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">apply_jitter</span><span class="p">(</span><span class="n">jitter</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">orient_relative_to_beam</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span></div>

<div class="viewcode-block" id="apply_jitter"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.apply_jitter">[docs]</a><span class="k">def</span> <span class="nf">apply_jitter</span><span class="p">(</span><span class="n">jitter</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply the jitter transform to a set of points.</span>

<span class="sd">    Points are stored in a 3 x n numpy matrix, not a numpy array or tuple.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">jitter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">points</span>
    <span class="c1"># Hack to deal with the fact that azimuthal_equidistance uses euler angles</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jitter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">dtheta</span><span class="p">,</span> <span class="n">dphi</span><span class="p">,</span> <span class="n">dpsi</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jitter</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">Rz</span><span class="p">(</span><span class="n">dphi</span><span class="p">)</span><span class="o">*</span><span class="n">Ry</span><span class="p">(</span><span class="n">dtheta</span><span class="p">)</span><span class="o">*</span><span class="n">Rz</span><span class="p">(</span><span class="n">dpsi</span><span class="p">)</span><span class="o">*</span><span class="n">points</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dtheta</span><span class="p">,</span> <span class="n">dphi</span><span class="p">,</span> <span class="n">dpsi</span> <span class="o">=</span> <span class="n">jitter</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">Rx</span><span class="p">(</span><span class="n">dphi</span><span class="p">)</span><span class="o">*</span><span class="n">Ry</span><span class="p">(</span><span class="n">dtheta</span><span class="p">)</span><span class="o">*</span><span class="n">Rz</span><span class="p">(</span><span class="n">dpsi</span><span class="p">)</span><span class="o">*</span><span class="n">points</span>
    <span class="k">return</span> <span class="n">points</span></div>

<div class="viewcode-block" id="orient_relative_to_beam"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.orient_relative_to_beam">[docs]</a><span class="k">def</span> <span class="nf">orient_relative_to_beam</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply the view transform to a set of points.</span>

<span class="sd">    Points are stored in a 3 x n numpy matrix, not a numpy array or tuple.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="n">view</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">Rz</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">Ry</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">Rz</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span><span class="o">*</span><span class="n">points</span> <span class="c1"># viewing angle</span>
    <span class="c1">#points = Rz(psi)*Ry(pi/2-theta)*Rz(phi)*points # 1-D integration angles</span>
    <span class="c1">#points = Rx(phi)*Ry(theta)*Rz(psi)*points  # angular dispersion angle</span>
    <span class="k">return</span> <span class="n">points</span></div>

<div class="viewcode-block" id="orient_relative_to_beam_quaternion"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.orient_relative_to_beam_quaternion">[docs]</a><span class="k">def</span> <span class="nf">orient_relative_to_beam_quaternion</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply the view transform to a set of points.</span>

<span class="sd">    Points are stored in a 3 x n numpy matrix, not a numpy array or tuple.</span>

<span class="sd">    This variant uses quaternions rather than rotation matrices for the</span>
<span class="sd">    computation.  It works but it is not used because it doesn&#39;t solve</span>
<span class="sd">    any problems.  The challenge of mapping theta/phi/psi to SO(3) does</span>
<span class="sd">    not disappear by calculating the transform differently.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="n">view</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">Quaternion</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="c1">## Compose a rotation about the three axes by rotating</span>
    <span class="c1">## the unit vectors before applying the rotation.</span>
    <span class="c1">#q = Quaternion.from_angle_axis(theta, q.rot(x)) * q</span>
    <span class="c1">#q = Quaternion.from_angle_axis(phi, q.rot(y)) * q</span>
    <span class="c1">#q = Quaternion.from_angle_axis(psi, q.rot(z)) * q</span>
    <span class="c1">## The above turns out to be equivalent to reversing</span>
    <span class="c1">## the order of application, so ignore it and use below.</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">Quaternion</span><span class="o">.</span><span class="n">from_angle_axis</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">Quaternion</span><span class="o">.</span><span class="n">from_angle_axis</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">Quaternion</span><span class="o">.</span><span class="n">from_angle_axis</span><span class="p">(</span><span class="n">psi</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="c1">## Reverse the order by post-multiply rather than pre-multiply</span>
    <span class="c1">#q = Quaternion.from_angle_axis(theta, x) * q</span>
    <span class="c1">#q = Quaternion.from_angle_axis(phi, y) * q</span>
    <span class="c1">#q = Quaternion.from_angle_axis(psi, z) * q</span>
    <span class="c1">#print(&quot;axes psi&quot;, q.rot(np.matrix([x, y, z]).T))</span>
    <span class="k">return</span> <span class="n">q</span><span class="o">.</span><span class="n">rot</span><span class="p">(</span><span class="n">points</span><span class="p">)</span></div>
<span class="c1">#orient_relative_to_beam = orient_relative_to_beam_quaternion</span>

<span class="c1"># === Quaterion class definition === BEGIN</span>
<span class="c1"># Simple stand-alone quaternion class</span>

<span class="c1"># Note: this code works but isn&#39;t unused since quaternions didn&#39;t solve the</span>
<span class="c1"># representation problem.  Leave it here in case we want to revisit this later.</span>

<span class="c1">#import numpy as np</span>
<div class="viewcode-block" id="Quaternion"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.Quaternion">[docs]</a><span class="k">class</span> <span class="nc">Quaternion</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Quaternion(w, r) = w + ir[0] + jr[1] + kr[2]</span>

<span class="sd">    Quaternion.from_angle_axis(theta, r) for a rotation of angle theta about</span>
<span class="sd">    an axis oriented toward the direction r.  This defines a unit quaternion,</span>
<span class="sd">    normalizing $r$ to the unit vector $\hat r$, and setting quaternion</span>
<span class="sd">    $Q = \cos \theta + \sin \theta \hat r$</span>

<span class="sd">    Quaternion objects can be multiplied, which applies a rotation about the</span>
<span class="sd">    given axis, allowing composition of rotations without risk of gimbal lock.</span>
<span class="sd">    The resulting quaternion is applied to a set of points using *Q.rot(v)*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Quaternion.from_angle_axis"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.Quaternion.from_angle_axis">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_angle_axis</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build quaternion as rotation theta about axis r&quot;&quot;&quot;</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Quaternion</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Multiply quaterions&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Quaternion</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">*</span><span class="n">other</span><span class="o">.</span><span class="n">w</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">*</span><span class="n">other</span><span class="o">.</span><span class="n">r</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">w</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Quaternion</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Quaternion * non-quaternion not implemented&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Quaternion.rot"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.Quaternion.rot">[docs]</a>    <span class="k">def</span> <span class="nf">rot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform point *v* by quaternion&quot;&quot;&quot;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">use_transpose</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_transpose</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">*</span><span class="n">v</span><span class="p">)</span>
        <span class="c1">#v = v + 2*self.w*np.cross(self.r, v) + np.cross(2*self.r, np.cross(self.r, v))</span>
        <span class="k">if</span> <span class="n">use_transpose</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span></div>

<div class="viewcode-block" id="Quaternion.conj"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.Quaternion.conj">[docs]</a>    <span class="k">def</span> <span class="nf">conj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Conjugate quaternion&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Quaternion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span></div>

<div class="viewcode-block" id="Quaternion.inv"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.Quaternion.inv">[docs]</a>    <span class="k">def</span> <span class="nf">inv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inverse quaternion&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span></div>

<div class="viewcode-block" id="Quaternion.norm"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.Quaternion.norm">[docs]</a>    <span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Quaternion length&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%g%+g</span><span class="s2">i</span><span class="si">%+g</span><span class="s2">j</span><span class="si">%+g</span><span class="s2">k&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span></div>

<div class="viewcode-block" id="test_qrot"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.test_qrot">[docs]</a><span class="k">def</span> <span class="nf">test_qrot</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Quaternion checks&quot;&quot;&quot;</span>
    <span class="c1"># Define rotation of 60 degrees around an axis in y-z that is 60 degrees</span>
    <span class="c1"># from y.  The rotation axis is determined by rotating the point [0, 1, 0]</span>
    <span class="c1"># about x.</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">Quaternion</span><span class="o">.</span><span class="n">from_angle_axis</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">rot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">Quaternion</span><span class="o">.</span><span class="n">from_angle_axis</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
    <span class="c1"># Set the point to be rotated, and its expected rotated position.</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">target</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">10</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="mi">14</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span>
    <span class="c1">#print(q, q.rot(p) - target)</span>
    <span class="k">assert</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">rot</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">target</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-14</span></div>
<span class="c1">#test_qrot()</span>
<span class="c1">#import sys; sys.exit()</span>
<span class="c1"># === Quaterion class definition === END</span>

<span class="c1"># translate between number of dimension of dispersity and the number of</span>
<span class="c1"># points along each dimension.</span>
<span class="n">PD_N_TABLE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>     <span class="c1"># 0</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>   <span class="c1"># 100</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>   <span class="c1"># 900</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>  <span class="c1"># 3375</span>
<span class="p">}</span>

<div class="viewcode-block" id="clipped_range"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.clipped_range">[docs]</a><span class="k">def</span> <span class="nf">clipped_range</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">portion</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;central&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine range from data.</span>

<span class="sd">    If *portion* is 1, use full range, otherwise use the center of the range</span>
<span class="sd">    or the top of the range, depending on whether *mode* is &#39;central&#39; or &#39;top&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">portion</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;central&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">portion</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="n">offset</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">portion</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Default: full range</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span></div>

<div class="viewcode-block" id="draw_scattering"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.draw_scattering">[docs]</a><span class="k">def</span> <span class="nf">draw_scattering</span><span class="p">(</span><span class="n">calculator</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the scattering for the particular view.</span>

<span class="sd">    *calculator* is returned from :func:`build_model`.  *axes* are the 3D axes</span>
<span class="sd">    on which the data will be plotted.  *view* and *jitter* are the current</span>
<span class="sd">    orientation and orientation dispersity.  *dist* is one of the sasmodels</span>
<span class="sd">    weight distributions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dist</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>  <span class="c1"># uniform is not yet in this branch</span>
        <span class="n">dist</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># add the orientation parameters to the model parameters</span>
    <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="n">view</span>
    <span class="n">theta_pd</span><span class="p">,</span> <span class="n">phi_pd</span><span class="p">,</span> <span class="n">psi_pd</span> <span class="o">=</span> <span class="p">[</span><span class="n">scale</span><span class="o">*</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">jitter</span><span class="p">]</span>
    <span class="n">theta_pd_n</span><span class="p">,</span> <span class="n">phi_pd_n</span><span class="p">,</span> <span class="n">psi_pd_n</span> <span class="o">=</span> <span class="n">PD_N_TABLE</span><span class="p">[(</span><span class="n">theta_pd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phi_pd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">psi_pd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="c1">## increase pd_n for testing jitter integration rather than simple viz</span>
    <span class="c1">#theta_pd_n, phi_pd_n, psi_pd_n = [5*v for v in (theta_pd_n, phi_pd_n, psi_pd_n)]</span>

    <span class="n">pars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span> <span class="n">theta_pd</span><span class="o">=</span><span class="n">theta_pd</span><span class="p">,</span> <span class="n">theta_pd_type</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">theta_pd_n</span><span class="o">=</span><span class="n">theta_pd_n</span><span class="p">,</span>
        <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span> <span class="n">phi_pd</span><span class="o">=</span><span class="n">phi_pd</span><span class="p">,</span> <span class="n">phi_pd_type</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">phi_pd_n</span><span class="o">=</span><span class="n">phi_pd_n</span><span class="p">,</span>
        <span class="n">psi</span><span class="o">=</span><span class="n">psi</span><span class="p">,</span> <span class="n">psi_pd</span><span class="o">=</span><span class="n">psi_pd</span><span class="p">,</span> <span class="n">psi_pd_type</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">psi_pd_n</span><span class="o">=</span><span class="n">psi_pd_n</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">calculator</span><span class="o">.</span><span class="n">pars</span><span class="p">)</span>

    <span class="c1"># compute the pattern</span>
    <span class="n">qx</span><span class="p">,</span> <span class="n">qy</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">qxqy</span>
    <span class="n">Iqxy</span> <span class="o">=</span> <span class="n">calculator</span><span class="p">(</span><span class="o">**</span><span class="n">pars</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qx</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">qy</span><span class="p">))</span>

    <span class="c1"># scale it and draw it</span>
    <span class="n">Iqxy</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">Iqxy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calculator</span><span class="o">.</span><span class="n">limits</span><span class="p">:</span>
        <span class="c1"># use limits from orientation (0,0,0)</span>
        <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">limits</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">Iqxy</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmax</span><span class="o">*</span><span class="mi">10</span><span class="o">**-</span><span class="mi">7</span>
        <span class="c1">#vmin, vmax = clipped_range(Iqxy, portion=portion, mode=&#39;top&#39;)</span>
    <span class="c1">#vmin, vmax = Iqxy.min(), Iqxy.max()</span>
    <span class="c1">#print(&quot;range&quot;,(vmin,vmax))</span>
    <span class="c1">#qx, qy = np.meshgrid(qx, qy)</span>
    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># pylint: disable=using-constant-test</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="p">(</span><span class="n">Iqxy</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">),</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">level</span><span class="p">[</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pylab</span> <span class="k">as</span> <span class="n">plt</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">()(</span><span class="n">level</span><span class="p">)</span>
        <span class="c1">#from matplotlib import cm</span>
        <span class="c1">#colors = cm.coolwarm(level)</span>
        <span class="c1">#colors = cm.gist_yarg(level)</span>
        <span class="c1">#colors = cm.Wistia(level)</span>
        <span class="n">colors</span><span class="p">[</span><span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># set floor to transparent</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">qx</span><span class="o">/</span><span class="n">qx</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">qy</span><span class="o">/</span><span class="n">qy</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">facecolors</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
    <span class="k">elif</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># pylint: disable=using-constant-test</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">qx</span><span class="o">/</span><span class="n">qx</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">qy</span><span class="o">/</span><span class="n">qy</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">Iqxy</span><span class="p">,</span> <span class="n">zdir</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=-</span><span class="mf">1.1</span><span class="p">,</span>
                      <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">qx</span><span class="p">,</span> <span class="n">qy</span><span class="p">,</span> <span class="n">Iqxy</span><span class="p">)</span></div>

<div class="viewcode-block" id="build_model"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.build_model">[docs]</a><span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">qmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">**</span><span class="n">pars</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a calculator for the given shape.</span>

<span class="sd">    *model_name* is any sasmodels model.  *n* and *qmax* define an n x n mesh</span>
<span class="sd">    on which to evaluate the model.  The remaining parameters are stored in</span>
<span class="sd">    the returned calculator as *calculator.pars*.  They are used by</span>
<span class="sd">    :func:`draw_scattering` to set the non-orientation parameters in the</span>
<span class="sd">    calculation.</span>

<span class="sd">    Returns a *calculator* function which takes a dictionary or parameters and</span>
<span class="sd">    produces Iqxy.  The Iqxy value needs to be reshaped to an n x n matrix</span>
<span class="sd">    for plotting.  See the :class:`.direct_model.DirectModel` class</span>
<span class="sd">    for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">sasmodels.core</span> <span class="k">import</span> <span class="n">load_model_info</span><span class="p">,</span> <span class="n">build_model</span> <span class="k">as</span> <span class="n">build_sasmodel</span>
    <span class="kn">from</span> <span class="nn">sasmodels.data</span> <span class="k">import</span> <span class="n">empty_data2D</span>
    <span class="kn">from</span> <span class="nn">sasmodels.direct_model</span> <span class="k">import</span> <span class="n">DirectModel</span>

    <span class="n">model_info</span> <span class="o">=</span> <span class="n">load_model_info</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">build_sasmodel</span><span class="p">(</span><span class="n">model_info</span><span class="p">)</span> <span class="c1">#, dtype=&#39;double!&#39;)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">qmax</span><span class="p">,</span> <span class="n">qmax</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">empty_data2D</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="n">calculator</span> <span class="o">=</span> <span class="n">DirectModel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

    <span class="c1"># Remember the data axes so we can plot the results</span>
    <span class="n">calculator</span><span class="o">.</span><span class="n">qxqy</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>

    <span class="c1"># stuff the values for non-orientation parameters into the calculator</span>
    <span class="n">calculator</span><span class="o">.</span><span class="n">pars</span> <span class="o">=</span> <span class="n">pars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">calculator</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;backgound&#39;</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)</span>

    <span class="c1"># fix the data limits so that we can see if the pattern fades</span>
    <span class="c1"># under rotation or angular dispersion</span>
    <span class="n">Iqxy</span> <span class="o">=</span> <span class="n">calculator</span><span class="p">(</span><span class="n">theta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">psi</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">calculator</span><span class="o">.</span><span class="n">pars</span><span class="p">)</span>
    <span class="n">Iqxy</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">Iqxy</span><span class="p">)</span>
    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">clipped_range</span><span class="p">(</span><span class="n">Iqxy</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
    <span class="n">calculator</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">+</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">calculator</span></div>

<div class="viewcode-block" id="select_calculator"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.select_calculator">[docs]</a><span class="k">def</span> <span class="nf">select_calculator</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">100</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a model calculator for the given shape.</span>

<span class="sd">    *model_name* is one of sphere, cylinder, ellipsoid, triaxial_ellipsoid,</span>
<span class="sd">    parallelepiped or bcc_paracrystal. *n* is the number of points to use</span>
<span class="sd">    in the q range.  *qmax* is chosen based on model parameters for the</span>
<span class="sd">    given model to show something intersting.</span>

<span class="sd">    Returns *calculator* and tuple *size* (a,b,c) giving minor and major</span>
<span class="sd">    equitorial axes and polar axis respectively.  See :func:`build_model`</span>
<span class="sd">    for details on the returned calculator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">size</span>
    <span class="n">d_factor</span> <span class="o">=</span> <span class="mf">0.06</span>  <span class="c1"># for paracrystal models</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;sphere&#39;</span><span class="p">:</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;sphere&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;sc_paracrystal&#39;</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
        <span class="n">dnn</span> <span class="o">=</span> <span class="n">c</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">c</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;sc_paracrystal&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">dnn</span><span class="o">=</span><span class="n">dnn</span><span class="p">,</span>
                                 <span class="n">d_factor</span><span class="o">=</span><span class="n">d_factor</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">d_factor</span><span class="p">)</span><span class="o">*</span><span class="n">radius</span><span class="p">,</span>
                                 <span class="n">background</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;fcc_paracrystal&#39;</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
        <span class="c1"># nearest neigbour distance dnn should be 2 radius, but I think the</span>
        <span class="c1"># model uses lattice spacing rather than dnn in its calculations</span>
        <span class="n">dnn</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">c</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span> <span class="o">*</span> <span class="n">c</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;fcc_paracrystal&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">dnn</span><span class="o">=</span><span class="n">dnn</span><span class="p">,</span>
                                 <span class="n">d_factor</span><span class="o">=</span><span class="n">d_factor</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">d_factor</span><span class="p">)</span><span class="o">*</span><span class="n">radius</span><span class="p">,</span>
                                 <span class="n">background</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;bcc_paracrystal&#39;</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
        <span class="c1"># nearest neigbour distance dnn should be 2 radius, but I think the</span>
        <span class="c1"># model uses lattice spacing rather than dnn in its calculations</span>
        <span class="n">dnn</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">c</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;bcc_paracrystal&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">dnn</span><span class="o">=</span><span class="n">dnn</span><span class="p">,</span>
                                 <span class="n">d_factor</span><span class="o">=</span><span class="n">d_factor</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">d_factor</span><span class="p">)</span><span class="o">*</span><span class="n">radius</span><span class="p">,</span>
                                 <span class="n">background</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;cylinder&#39;</span><span class="p">:</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;cylinder&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">qmax</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;ellipsoid&#39;</span><span class="p">:</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;ellipsoid&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">qmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                 <span class="n">radius_polar</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">radius_equatorial</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;triaxial_ellipsoid&#39;</span><span class="p">:</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;triaxial_ellipsoid&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">qmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                 <span class="n">radius_equat_minor</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
                                 <span class="n">radius_equat_major</span><span class="o">=</span><span class="n">b</span><span class="p">,</span>
                                 <span class="n">radius_polar</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;parallelepiped&#39;</span><span class="p">:</span>
        <span class="n">calculator</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="s1">&#39;parallelepiped&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unknown model </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">model_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">calculator</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span></div>

<span class="n">SHAPES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;parallelepiped&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sphere&#39;</span><span class="p">,</span> <span class="s1">&#39;ellipsoid&#39;</span><span class="p">,</span> <span class="s1">&#39;triaxial_ellipsoid&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cylinder&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fcc_paracrystal&#39;</span><span class="p">,</span> <span class="s1">&#39;bcc_paracrystal&#39;</span><span class="p">,</span> <span class="s1">&#39;sc_paracrystal&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">DRAW_SHAPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;fcc_paracrystal&#39;</span><span class="p">:</span> <span class="n">draw_fcc</span><span class="p">,</span>
    <span class="s1">&#39;bcc_paracrystal&#39;</span><span class="p">:</span> <span class="n">draw_bcc</span><span class="p">,</span>
    <span class="s1">&#39;sc_paracrystal&#39;</span><span class="p">:</span> <span class="n">draw_sc</span><span class="p">,</span>
    <span class="s1">&#39;parallelepiped&#39;</span><span class="p">:</span> <span class="n">draw_parallelepiped</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">DISTRIBUTIONS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">,</span> <span class="s1">&#39;uniform&#39;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">DIST_LIMITS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
    <span class="s1">&#39;rectangle&#39;</span><span class="p">:</span> <span class="mi">90</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="s1">&#39;uniform&#39;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;parallelepiped&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
        <span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">jitter</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;equirectangular&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show an interactive orientation and jitter demo.</span>

<span class="sd">    *model_name* is one of: sphere, ellipsoid, triaxial_ellipsoid,</span>
<span class="sd">    parallelepiped, cylinder, or sc/fcc/bcc_paracrystal</span>

<span class="sd">    *size* gives the dimensions (a, b, c) of the shape.</span>

<span class="sd">    *view* gives the initial view (theta, phi, psi) of the shape.</span>

<span class="sd">    *view* gives the initial jitter (dtheta, dphi, dpsi) of the shape.</span>

<span class="sd">    *dist* is the type of dispersition: gaussian, rectangle, or uniform.</span>

<span class="sd">    *mesh* is the number of points in the dispersion mesh.</span>

<span class="sd">    *projection* is the map projection to use for the mesh: equirectangular,</span>
<span class="sd">    sinusoidal, guyou, azimuthal_equidistance, or azimuthal_equal_area.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># projection number according to 1-order position in list, but</span>
    <span class="c1"># only 1 and 2 are implemented so far.</span>
    <span class="kn">from</span> <span class="nn">sasmodels</span> <span class="k">import</span> <span class="n">generate</span>
    <span class="n">generate</span><span class="o">.</span><span class="n">PROJECTION</span> <span class="o">=</span> <span class="n">PROJECTIONS</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">generate</span><span class="o">.</span><span class="n">PROJECTION</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** PROJECTION </span><span class="si">%s</span><span class="s2"> not implemented in scattering function ***&quot;</span><span class="o">%</span><span class="n">projection</span><span class="p">)</span>
        <span class="n">generate</span><span class="o">.</span><span class="n">PROJECTION</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># set up calculator</span>
    <span class="n">calculator</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">select_calculator</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
    <span class="n">draw_shape</span> <span class="o">=</span> <span class="n">DRAW_SHAPES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">draw_parallelepiped</span><span class="p">)</span>
    <span class="c1">#draw_shape = draw_fcc</span>

    <span class="c1">## uncomment to set an independent the colour range for every view</span>
    <span class="c1">## If left commented, the colour range is fixed for all views</span>
    <span class="n">calculator</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">PLOT_ENGINE</span><span class="p">(</span><span class="n">calculator</span><span class="p">,</span> <span class="n">draw_shape</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">projection</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_mpl_plot</span><span class="p">(</span><span class="n">calculator</span><span class="p">,</span> <span class="n">draw_shape</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">projection</span><span class="p">):</span>
    <span class="c1"># Note: travis-ci does not support mpl_toolkits.mplot3d, but this shouldn&#39;t be</span>
    <span class="c1"># an issue since we are lazy-loading the package on a path that isn&#39;t tested.</span>
    <span class="c1"># Importing mplot3d adds projection=&#39;3d&#39; option to subplot</span>
    <span class="kn">import</span> <span class="nn">mpl_toolkits.mplot3d</span>  <span class="c1"># pylint: disable=unused-variable</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">from</span> <span class="nn">matplotlib.widgets</span> <span class="k">import</span> <span class="n">Slider</span>

    <span class="c1">## create the plot window</span>
    <span class="c1">#plt.hold(True)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="s1">&#39;gist_earth&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
    <span class="c1">#gs = gridspec.GridSpec(2,1,height_ratios=[4,1])</span>
    <span class="c1">#axes = plt.subplot(gs[0], projection=&#39;3d&#39;)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>  <span class="c1"># CRUFT: not all versions of matplotlib accept &#39;square&#39; 3d projection</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;square&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># CRUFT: use axisbg instead of facecolor for matplotlib&lt;2</span>
    <span class="n">facecolor_prop</span> <span class="o">=</span> <span class="s1">&#39;facecolor&#39;</span> <span class="k">if</span> <span class="n">mpl</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;</span> <span class="s1">&#39;2&#39;</span> <span class="k">else</span> <span class="s1">&#39;axisbg&#39;</span>
    <span class="n">props</span> <span class="o">=</span> <span class="p">{</span><span class="n">facecolor_prop</span><span class="p">:</span> <span class="s1">&#39;lightgoldenrodyellow&#39;</span><span class="p">}</span>

    <span class="c1">## add control widgets to plot</span>
    <span class="n">axes_theta</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">],</span> <span class="o">**</span><span class="n">props</span><span class="p">)</span>
    <span class="n">axes_phi</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">],</span> <span class="o">**</span><span class="n">props</span><span class="p">)</span>
    <span class="n">axes_psi</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">],</span> <span class="o">**</span><span class="n">props</span><span class="p">)</span>
    <span class="n">stheta</span> <span class="o">=</span> <span class="n">Slider</span><span class="p">(</span><span class="n">axes_theta</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;θ&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">valinit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sphi</span> <span class="o">=</span> <span class="n">Slider</span><span class="p">(</span><span class="n">axes_phi</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;φ&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="n">valinit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">spsi</span> <span class="o">=</span> <span class="n">Slider</span><span class="p">(</span><span class="n">axes_psi</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;ψ&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="n">valinit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">axes_dtheta</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">],</span> <span class="o">**</span><span class="n">props</span><span class="p">)</span>
    <span class="n">axes_dphi</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">],</span> <span class="o">**</span><span class="n">props</span><span class="p">)</span>
    <span class="n">axes_dpsi</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">],</span> <span class="o">**</span><span class="n">props</span><span class="p">)</span>

    <span class="c1"># Note: using ridiculous definition of rectangle distribution, whose width</span>
    <span class="c1"># in sasmodels is sqrt(3) times the given width.  Divide by sqrt(3) to keep</span>
    <span class="c1"># the maximum width to 90.</span>
    <span class="n">dlimit</span> <span class="o">=</span> <span class="n">DIST_LIMITS</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span>
    <span class="n">sdtheta</span> <span class="o">=</span> <span class="n">Slider</span><span class="p">(</span><span class="n">axes_dtheta</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Δθ&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">dlimit</span><span class="p">,</span> <span class="n">valinit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sdphi</span> <span class="o">=</span> <span class="n">Slider</span><span class="p">(</span><span class="n">axes_dphi</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Δφ&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">dlimit</span><span class="p">,</span> <span class="n">valinit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sdpsi</span> <span class="o">=</span> <span class="n">Slider</span><span class="p">(</span><span class="n">axes_dpsi</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;Δψ&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">dlimit</span><span class="p">,</span> <span class="n">valinit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1">## initial view and jitter</span>
    <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="n">view</span>
    <span class="n">stheta</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">sphi</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">spsi</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>
    <span class="n">dtheta</span><span class="p">,</span> <span class="n">dphi</span><span class="p">,</span> <span class="n">dpsi</span> <span class="o">=</span> <span class="n">jitter</span>
    <span class="n">sdtheta</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">dtheta</span><span class="p">)</span>
    <span class="n">sdphi</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">dphi</span><span class="p">)</span>
    <span class="n">sdpsi</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">dpsi</span><span class="p">)</span>

    <span class="c1">## callback to draw the new view</span>
    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">stheta</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">sphi</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">spsi</span><span class="o">.</span><span class="n">val</span>
        <span class="n">jitter</span> <span class="o">=</span> <span class="n">sdtheta</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">sdphi</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">sdpsi</span><span class="o">.</span><span class="n">val</span>
        <span class="c1"># set small jitter as 0 if multiple pd dims</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">jitter</span><span class="p">)</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">][</span><span class="n">dims</span><span class="p">]</span>
        <span class="n">jitter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">jitter</span><span class="p">]</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>

        <span class="c1">## Visualize as person on globe</span>
        <span class="c1">#draw_sphere(axes, radius=0.5)</span>
        <span class="c1">#draw_person_on_sphere(axes, view, radius=0.5)</span>

        <span class="c1">## Move beam instead of shape</span>
        <span class="c1">#draw_beam(axes, -view[:2])</span>
        <span class="c1">#draw_jitter(axes, (0,0,0), (0,0,0), views=3)</span>

        <span class="c1">## Move shape and draw scattering</span>
        <span class="n">draw_beam</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="c1">#draw_person_on_sphere(axes, view, radius=1.2, height=0.5)</span>
        <span class="n">draw_jitter</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                    <span class="n">draw_shape</span><span class="o">=</span><span class="n">draw_shape</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">views</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">draw_mesh</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
        <span class="n">draw_scattering</span><span class="p">(</span><span class="n">calculator</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="c1">## bind control widgets to view updater</span>
    <span class="n">stheta</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">_update</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">))</span>
    <span class="n">sphi</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">_update</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">))</span>
    <span class="n">spsi</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">_update</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;psi&#39;</span><span class="p">))</span>
    <span class="n">sdtheta</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">_update</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;dtheta&#39;</span><span class="p">))</span>
    <span class="n">sdphi</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">_update</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;dphi&#39;</span><span class="p">))</span>
    <span class="n">sdpsi</span><span class="o">.</span><span class="n">on_changed</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">_update</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;dpsi&#39;</span><span class="p">))</span>

    <span class="c1">## initialize view</span>
    <span class="n">_update</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">)</span>

    <span class="c1">## go interactive</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<div class="viewcode-block" id="map_colors"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.map_colors">[docs]</a><span class="k">def</span> <span class="nf">map_colors</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process matplotlib-style colour arguments.</span>

<span class="sd">    Pulls &#39;cmap&#39;, &#39;alpha&#39;, &#39;vmin&#39;, and &#39;vmax&#39; from th *kw* dictionary, setting</span>
<span class="sd">    the *kw[&#39;color&#39;]* to an RGB array.  These are ignored if &#39;c&#39; or &#39;color&#39; are</span>
<span class="sd">    set inside *kw*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">cm</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cmap&#39;</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">vmin</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;vmin&#39;</span><span class="p">,</span> <span class="n">z</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;vmax&#39;</span><span class="p">,</span> <span class="n">z</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">znorm</span> <span class="o">=</span> <span class="p">((</span><span class="n">z</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">))</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">znorm</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">color</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span>
    <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span></div>

<div class="viewcode-block" id="make_vec"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.make_vec">[docs]</a><span class="k">def</span> <span class="nf">make_vec</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turn all elements of *args* into numpy arrays&quot;&quot;&quot;</span>
    <span class="c1">#return [np.asarray(v, &#39;d&#39;).flatten() for v in args]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span></div>

<div class="viewcode-block" id="make_image"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.make_image">[docs]</a><span class="k">def</span> <span class="nf">make_image</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert numpy array *z* into a *PIL* RGB image.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">PIL.Image</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">cm</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cmap&#39;</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">coolwarm</span><span class="p">)</span>

    <span class="n">znorm</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">z</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="n">z</span><span class="o">.</span><span class="n">ptp</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">znorm</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="mi">255</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span></div>


<span class="n">_IPV_MARKERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;o&#39;</span><span class="p">:</span> <span class="s1">&#39;sphere&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">_IPV_COLORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span>
    <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
    <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="s1">&#39;cyan&#39;</span><span class="p">,</span>
    <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="s1">&#39;magenta&#39;</span><span class="p">,</span>
    <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;yellow&#39;</span><span class="p">,</span>
    <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
    <span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span>
    <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="k">def</span> <span class="nf">_ipv_fix_color</span><span class="p">(</span><span class="n">kw</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">_IPV_COLORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
        <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
    <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
        <span class="c1">#TODO: convert color to [r, g, b, a] if not already</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">alpha</span><span class="o">*</span><span class="n">color</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">color</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">color</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span>
            <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>

<span class="k">def</span> <span class="nf">_ipv_set_transparency</span><span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">color</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">transparent</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">side</span> <span class="o">=</span> <span class="s2">&quot;FrontSide&quot;</span>

<div class="viewcode-block" id="ipv_axes"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.ipv_axes">[docs]</a><span class="k">def</span> <span class="nf">ipv_axes</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a matplotlib style Axes interface for ipyvolume</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">ipyvolume</span> <span class="k">as</span> <span class="nn">ipv</span>

    <span class="k">class</span> <span class="nc">Axes</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Matplotlib Axes3D style interface to ipyvolume renderer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use,no-init</span>
        <span class="c1"># transparency can be achieved by setting the following:</span>
        <span class="c1">#    mesh.color = [r, g, b, alpha]</span>
        <span class="c1">#    mesh.material.transparent = True</span>
        <span class="c1">#    mesh.material.side = &quot;FrontSide&quot;</span>
        <span class="c1"># smooth(ish) rotation can be achieved by setting:</span>
        <span class="c1">#    slide.continuous_update = True</span>
        <span class="c1">#    figure.animation = 0.</span>
        <span class="c1">#    mesh.material.x = x</span>
        <span class="c1">#    mesh.material.y = y</span>
        <span class="c1">#    mesh.material.z = z</span>
        <span class="c1"># maybe need to synchronize update of x/y/z to avoid shimmy when moving</span>
        <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;mpl style plot interface for ipyvolume&quot;&quot;&quot;</span>
            <span class="n">_ipv_fix_color</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">make_vec</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">ipv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">plot_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;mpl style plot_surface interface for ipyvolume&quot;&quot;&quot;</span>
            <span class="n">facecolors</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;facecolors&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">facecolors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">facecolors</span>
            <span class="n">_ipv_fix_color</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">make_vec</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">ipv</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">_ipv_set_transparency</span><span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
            <span class="c1">#h.material.side = &quot;DoubleSide&quot;</span>
            <span class="k">return</span> <span class="n">h</span>
        <span class="k">def</span> <span class="nf">plot_trisurf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">triangles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;mpl style plot_trisurf interface for ipyvolume&quot;&quot;&quot;</span>
            <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;linewidth&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">_ipv_fix_color</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">make_vec</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">triangles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">triangles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">triangles</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">ipv</span><span class="o">.</span><span class="n">plot_trisurf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">triangles</span><span class="o">=</span><span class="n">triangles</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">_ipv_set_transparency</span><span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">h</span>
        <span class="k">def</span> <span class="nf">scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;mpl style scatter interface for ipyvolume&quot;&quot;&quot;</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">make_vec</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">map_colors</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
            <span class="n">marker</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;marker&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;marker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_IPV_MARKERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="n">marker</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">ipv</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">_ipv_set_transparency</span><span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">h</span>
        <span class="k">def</span> <span class="nf">contourf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">zdir</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;mpl style contourf interface for ipyvolume&quot;&quot;&quot;</span>
            <span class="c1"># pylint: disable=unused-argument</span>
            <span class="c1"># Don&#39;t use contour for now (although we might want to later)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pcolor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">zdir</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">pcolor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">zdir</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;mpl style pcolor interface for ipyvolume&quot;&quot;&quot;</span>
            <span class="c1"># pylint: disable=unused-argument</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">make_vec</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">make_image</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">],</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">]])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">],</span> <span class="p">[</span><span class="n">ymax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]])</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span> <span class="o">+</span> <span class="n">offset</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">ipv</span><span class="o">.</span><span class="n">plot_mesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">texture</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">wireframe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">_ipv_set_transparency</span><span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
            <span class="n">h</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">side</span> <span class="o">=</span> <span class="s2">&quot;DoubleSide&quot;</span>
            <span class="k">return</span> <span class="n">h</span>
        <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;mpl style text interface for ipyvolume&quot;&quot;&quot;</span>
            <span class="k">pass</span>
        <span class="k">def</span> <span class="nf">set_xlim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;mpl style set_xlim interface for ipyvolume&quot;&quot;&quot;</span>
            <span class="n">ipv</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">*</span><span class="n">limits</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">set_ylim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;mpl style set_ylim interface for ipyvolume&quot;&quot;&quot;</span>
            <span class="n">ipv</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">*</span><span class="n">limits</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">set_zlim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;mpl style set_zlim interface for ipyvolume&quot;&quot;&quot;</span>
            <span class="n">ipv</span><span class="o">.</span><span class="n">zlim</span><span class="p">(</span><span class="o">*</span><span class="n">limits</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">set_axes_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;mpl style set_axes_on interface for ipyvolume&quot;&quot;&quot;</span>
            <span class="n">ipv</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">axis_on</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">set_axis_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;mpl style set_axes_off interface for ipyvolume&quot;&quot;&quot;</span>
            <span class="n">ipv</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">axes_off</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Axes</span><span class="p">()</span></div>

<span class="k">def</span> <span class="nf">_ipv_plot</span><span class="p">(</span><span class="n">calculator</span><span class="p">,</span> <span class="n">draw_shape</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">projection</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="k">import</span> <span class="n">display</span>
    <span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>
    <span class="kn">import</span> <span class="nn">ipyvolume</span> <span class="k">as</span> <span class="nn">ipv</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="n">ipv_axes</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_draw</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">):</span>
        <span class="n">camera</span> <span class="o">=</span> <span class="n">ipv</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span>
        <span class="c1">#print(ipv.gcf().__dict__.keys())</span>
        <span class="c1">#print(dir(ipv.gcf()))</span>
        <span class="n">ipv</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">animation</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>  <span class="c1"># no animation when updating object mesh</span>

        <span class="c1"># set small jitter as 0 if multiple pd dims</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">jitter</span><span class="p">)</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">][</span><span class="n">dims</span><span class="p">]</span>
        <span class="n">jitter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">jitter</span><span class="p">]</span>

        <span class="c1">## Visualize as person on globe</span>
        <span class="c1">#draw_beam(axes, (0, 0))</span>
        <span class="c1">#draw_sphere(axes, radius=0.5)</span>
        <span class="c1">#draw_person_on_sphere(axes, view, radius=0.5)</span>

        <span class="c1">## Move beam instead of shape</span>
        <span class="c1">#draw_beam(axes, view=(-view[0], -view[1]))</span>
        <span class="c1">#draw_jitter(axes, view=(0,0,0), jitter=(0,0,0))</span>

        <span class="c1">## Move shape and draw scattering</span>
        <span class="n">draw_beam</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">steps</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
        <span class="n">draw_jitter</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">draw_shape</span><span class="o">=</span><span class="n">draw_shape</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
        <span class="n">draw_mesh</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
                  <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
        <span class="n">draw_scattering</span><span class="p">(</span><span class="n">calculator</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">)</span>

        <span class="n">draw_axes</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1</span><span class="p">))</span>
        <span class="n">ipv</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">box_off</span><span class="p">()</span>
        <span class="n">ipv</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">axes_off</span><span class="p">()</span>
        <span class="n">ipv</span><span class="o">.</span><span class="n">xyzlabel</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="n">ipv</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="n">camera</span>
        <span class="n">ipv</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


    <span class="n">trange</span><span class="p">,</span> <span class="n">prange</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">dtrange</span><span class="p">,</span> <span class="n">dprange</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>

    <span class="c1">## Super simple interfaca, but uses non-ascii variable namese</span>
    <span class="c1"># θ φ ψ Δθ Δφ Δψ</span>
    <span class="c1">#def update(**kw):</span>
    <span class="c1">#    view = kw[&#39;θ&#39;], kw[&#39;φ&#39;], kw[&#39;ψ&#39;]</span>
    <span class="c1">#    jitter = kw[&#39;Δθ&#39;], kw[&#39;Δφ&#39;], kw[&#39;Δψ&#39;]</span>
    <span class="c1">#    draw(view, jitter)</span>
    <span class="c1">#widgets.interact(update, θ=trange, φ=prange, ψ=prange, Δθ=dtrange, Δφ=dprange, Δψ=dprange)</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">dphi</span><span class="p">,</span> <span class="n">dpsi</span><span class="p">):</span>
        <span class="n">_draw</span><span class="p">(</span><span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span><span class="p">),</span> <span class="n">jitter</span><span class="o">=</span><span class="p">(</span><span class="n">dtheta</span><span class="p">,</span> <span class="n">dphi</span><span class="p">,</span> <span class="n">dpsi</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_slider</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">slice</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
            <span class="nb">min</span><span class="o">=</span><span class="nb">slice</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="nb">max</span><span class="o">=</span><span class="nb">slice</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">step</span><span class="o">=</span><span class="nb">slice</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="c1">#continuous_update=True,</span>
            <span class="n">continuous_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span>
            <span class="n">readout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">readout_format</span><span class="o">=</span><span class="s1">&#39;.1f&#39;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">_slider</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;θ&#39;</span><span class="p">,</span> <span class="n">trange</span><span class="p">,</span> <span class="n">view</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">_slider</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;φ&#39;</span><span class="p">,</span> <span class="n">prange</span><span class="p">,</span> <span class="n">view</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">_slider</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;ψ&#39;</span><span class="p">,</span> <span class="n">prange</span><span class="p">,</span> <span class="n">view</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">dtheta</span> <span class="o">=</span> <span class="n">_slider</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Δθ&#39;</span><span class="p">,</span> <span class="n">dtrange</span><span class="p">,</span> <span class="n">jitter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">dphi</span> <span class="o">=</span> <span class="n">_slider</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Δφ&#39;</span><span class="p">,</span> <span class="n">dprange</span><span class="p">,</span> <span class="n">jitter</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dpsi</span> <span class="o">=</span> <span class="n">_slider</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Δψ&#39;</span><span class="p">,</span> <span class="n">dprange</span><span class="p">,</span> <span class="n">jitter</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">:</span> <span class="n">phi</span><span class="p">,</span> <span class="s1">&#39;psi&#39;</span><span class="p">:</span> <span class="n">psi</span><span class="p">,</span>
        <span class="s1">&#39;dtheta&#39;</span><span class="p">:</span> <span class="n">dtheta</span><span class="p">,</span> <span class="s1">&#39;dphi&#39;</span><span class="p">:</span> <span class="n">dphi</span><span class="p">,</span> <span class="s1">&#39;dpsi&#39;</span><span class="p">:</span> <span class="n">dpsi</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">ui</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span>
        <span class="n">widgets</span><span class="o">.</span><span class="n">VBox</span><span class="p">([</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span><span class="p">]),</span>
        <span class="n">widgets</span><span class="o">.</span><span class="n">VBox</span><span class="p">([</span><span class="n">dtheta</span><span class="p">,</span> <span class="n">dphi</span><span class="p">,</span> <span class="n">dpsi</span><span class="p">])</span>
    <span class="p">])</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">interactive_output</span><span class="p">(</span><span class="n">_update</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">ui</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>


<span class="n">_ENGINES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;matplotlib&quot;</span><span class="p">:</span> <span class="n">_mpl_plot</span><span class="p">,</span>
    <span class="s2">&quot;mpl&quot;</span><span class="p">:</span> <span class="n">_mpl_plot</span><span class="p">,</span>
    <span class="c1">#&quot;plotly&quot;: _plotly_plot,</span>
    <span class="s2">&quot;ipvolume&quot;</span><span class="p">:</span> <span class="n">_ipv_plot</span><span class="p">,</span>
    <span class="s2">&quot;ipv&quot;</span><span class="p">:</span> <span class="n">_ipv_plot</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">PLOT_ENGINE</span> <span class="o">=</span> <span class="n">_ENGINES</span><span class="p">[</span><span class="s2">&quot;matplotlib&quot;</span><span class="p">]</span>
<div class="viewcode-block" id="set_plotter"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.set_plotter">[docs]</a><span class="k">def</span> <span class="nf">set_plotter</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setting the plotting engine to matplotlib/ipyvolume or equivalently mpl/ipv.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">PLOT_ENGINE</span>
    <span class="n">PLOT_ENGINE</span> <span class="o">=</span> <span class="n">_ENGINES</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>

<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../dev/sasmodels-api/sasmodels.html#sasmodels.jitter.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Command line interface to the jitter viewer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Display jitter&quot;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--projection&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">PROJECTIONS</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="n">PROJECTIONS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;coordinate projection&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;10,40,100&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;a,b,c lengths&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--view&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;0,0,0&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;initial view angles&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-j&#39;</span><span class="p">,</span> <span class="s1">&#39;--jitter&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;0,0,0&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;initial angular dispersion&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--distribution&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">DISTRIBUTIONS</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="n">DISTRIBUTIONS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;jitter distribution&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;--mesh&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;#points in theta-phi mesh&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">SHAPES</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">SHAPES</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;oriented shape&#39;</span><span class="p">)</span>
    <span class="n">opts</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
    <span class="n">view</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
    <span class="n">jitter</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">jitter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
    <span class="n">run</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="n">view</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="n">jitter</span><span class="p">,</span>
        <span class="n">mesh</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">distribution</span><span class="p">,</span>
        <span class="n">projection</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">projection</span><span class="p">)</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SasView 5.0.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../sasmodels.html" >sasmodels</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, The SasView Project.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4.
    </div>
  </body>
</html>